<div class="station-layout">
  <!-- Left Nav Rail (icons, signage) -->
  <aside class="station-nav">
    {% include station-signage.html %}
  </aside>

  <!-- Center Visualizer or Panels -->
  <main class="station-main">
    {% assign lines = station_info.lines | join: " " %}
    <div class="viz-wrap" data-lines="{{ lines }}">
      <canvas id="viz" width="1280" height="720" aria-hidden="true"></canvas>
    </div>
  </main>

  <!-- Right Dock Panel for Description -->
  <aside class="station-desc feature-dock is-collapsed" id="stationDock">
    <button class="dock-toggle" onclick="toggleDock('stationDock')">
      Station Info
    </button>
    <div class="dock-inner">
      {% include station-desc.html %}
    </div>
  </aside>
</div>

<script>
(() => {
  function onReady(fn){
    if (document.getElementById('audio')) return fn();
    document.addEventListener('player:ready', fn, { once:true });
  }

  function toggleDock(id){
  document.getElementById(id).classList.toggle('is-collapsed');
}


  onReady(() => {
    const audio = document.getElementById('audio');
    if (!audio) return;

    const ac = new (window.AudioContext || window.webkitAudioContext)();
    const src = ac.createMediaElementSource(audio);
    const analyser = ac.createAnalyser();
    analyser.fftSize = 1024;
    src.connect(analyser); src.connect(ac.destination);

    const c = document.getElementById('viz');
    const ctx = c.getContext('2d');
    const w = () => c.width  = c.clientWidth  || c.width;
    const h = () => c.height = c.clientHeight || c.height;
    w(); h(); addEventListener('resize', () => { w(); h(); });

    const buf = new Uint8Array(analyser.frequencyBinCount);
    let t = 0;

    function draw(){
      requestAnimationFrame(draw);
      analyser.getByteFrequencyData(buf);

      ctx.fillStyle = 'rgba(10,10,10,0.08)';
      ctx.fillRect(0,0,c.width,c.height);

      // energy calc
      const energy = buf.slice(4,64).reduce((s,v)=>s+v,0)/60;
      t += 0.015 + energy*0.0005;

      const cx = c.width/2, cy = c.height/2;
      const r1 = Math.min(cx,cy)*0.72, r2 = r1*0.47;
      const x = cx + r1*Math.sin(t*0.8) + r2*Math.sin(t*1.9);
      const y = cy + r1*Math.cos(t*0.9) + r2*Math.cos(t*1.7);

      const color = getComputedStyle(c.closest('.viz-wrap')).getPropertyValue('--viz-color') || '#fff';

      ctx.beginPath();
      ctx.arc(x,y, 2 + energy*0.02, 0, Math.PI*2);
      ctx.fillStyle = color.trim();
      ctx.fill();

      ctx.strokeStyle = color.trim() + '33'; // tail translucent
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let i=0;i<120;i++){
        const tt = t - i*0.03;
        const xx = cx + r1*Math.sin(tt*0.8) + r2*Math.sin(tt*1.9);
        const yy = cy + r1*Math.cos(tt*0.9) + r2*Math.cos(tt*1.7);
        i?ctx.lineTo(xx,yy):ctx.moveTo(xx,yy);
      }
      ctx.stroke();
    }
    draw();

    const unlock = () => { if (ac.state === 'suspended') ac.resume(); removeEventListener('click',unlock); };
    addEventListener('click', unlock, { once:true });
  });
})();
</script>
